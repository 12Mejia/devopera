Title: Keyboard-accessible Google Maps
----
Date: 2008-11-07 13:07:00
----
Lang: en
----
Author: 
----
License: Creative Commons Attribution, Non Commercial - Share Alike 2.5
----
License_url: http://creativecommons.org/licenses/by-nc-sa/2.5/
----
Text:

<h2>Introduction</h2>

<p>Google Maps is a powerful, free tool for adding maps to a site. Unfortunately, out of the box, these maps are reliant on mouse interaction; therefore, they are completely inaccessible to those using only the keyboard for Web interaction. In this article, we&#39;ll examine the problem and, step by step, make our way toward a possible solution.</p>

<p>I&#39;ll assume that you&#39;re familiar with the basics of <a href="http://code.google.com/apis/maps/">Google Maps</a>, have <a href="http://code.google.com/apis/maps/signup.html">obtained your API key </a>, and implemented a map on your site. Now, let&#39;s say that you want to make your map a tad more accessible but without changing the look and feel of your existing map (maybe because your boss or designer insists on it)— a case of <em>unobtrusive accessibility</em>, if you will.</p>
<p class="note">Added 15 June 2010: Since this article was written, version 3 of the API and version 2 of the Static Maps API no longer require API keys. Otherwise, the code is unchanged.</p>

<h2>A basic map</h2>

<p>To understand the problem of keyboard access, let&#39;s use Google&#39;s own example code as a starting point to display a map of Manchester, England.</p>

<p>We&#39;ll begin by using the lesser-known <a href="http://code.google.com/apis/maps/documentation/staticmaps/">Google Static Maps API</a> to place an image of our desired starting map on a page, wrapped in a simple container <code>div</code>. In the absence of JavaScript, this provides users with a basic fallback:</p>

<pre><code>&lt;div id=&quot;map_canvas&quot;&gt;
  &lt;img src=&quot;http://maps.google.com/staticmap?center=53.480998,-2.236748
  &amp;zoom=15&amp;size=450x350&amp;key=[YOUR API KEY]&quot;
  width=&quot;450&quot; height=&quot;350&quot;
  alt=&quot;Map of Manchester, UK&quot; /&gt;
&lt;/div&gt;</code></pre>

<p><a href="demo01.html">View demo 1</a> to see this in action.</p>

<p>Next, we&#39;ll use the &quot;regular&quot; <a href="http://code.google.com/apis/maps/documentation/introduction.html">Google Maps API</a> to replace the static contents of the container <code>div</code> with a dynamic map, including large pan/zoom and map type controls. We&#39;ll also enable use of the scroll wheel and continuous zoom:</p>

<pre><code>&lt;script src=&quot;http://maps.google.com/maps?file=api&amp;v=2&amp;key=[YOUR API KEY]&quot;
  type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
function initialize() {
  if (GBrowserIsCompatible()) {
    var map = new GMap2(document.getElementById(&quot;map_canvas&quot;));
    map.setCenter(new GLatLng(53.480998, -2.236748), 15);
    map.addControl(new GLargeMapControl());
    map.addControl(new GMapTypeControl());
    map.enableScrollWheelZoom();
    map.enableContinuousZoom();
  }
}
&lt;/script&gt;</code></pre>

<p><a href="demo02.html">View demo 2</a> to see this in action.</p>

<p>At this point, we have a standard Google Map. It functions perfectly well when using your mouse and scroll wheel to move around, zoom or switch map types. However, if you try using the keyboard to <kbd>Tab</kbd> to the individual controls (apart from the <em>Powered by Google</em> and <em>Terms &amp; Use</em> links), you&#39;re out of luck&#x2014;there&#39;s nothing else that can receive focus via keyboard interaction.</p>

<h2>Markup breakdown</h2>

<p>Using a tool such as <a href="http://www.opera.com/products/dragonfly/">Opera Dragonfly</a> (access it in the latest version of the <a href="http://www.opera.com/products/desktop/">Opera browser</a> by activating the context menu and choosing <var>Inspect Element</var>) you can get a rough idea of what&#39;s going on—see Figure 1.</p>

<div>
<img src="http://forum-test.oslo.osa/kirby/content/articles/175-keyboardaccessible-google-maps/demo02-dragonfly.png" alt="Opera Dragonfly, showing an extract of the DOM generated by the Google Maps API." width="640" height="831" />
<p class="comment">Figure 1: Opera Dragonfly, showing an extract of the DOM generated by the Google Maps API</p>
</div>

<p>Once Google&#39;s script is run, the content of <code>&lt;div id=&quot;map_canvas&quot;&gt;</code> is replaced with a large amount of markup for the various map tiles and controls. Unless you&#39;re a masochist, I would not recommend trying to make sense of all that you will find there, but to explain the coming steps, it&#39;s worth pointing out some blocks of code (with areas of interest highlighted for slightly better readability).</p>

<pre><code>&lt;div class=&quot;gmnoprint&quot; style=&quot;overflow: hidden; width: 59px; height: 256px; -moz-user-select: none; position: absolute; left: 7px; top: 7px;&quot;&gt;

  &lt;div style=&quot;overflow: hidden; position: absolute; left: 0px; top: 0px; width: 59px; height: 226px;&quot;&gt;
    &lt;div style=&quot;overflow: hidden; width: 59px; height: 354px;&quot;&gt;
      <strong>&lt;img style=&quot;border: 0px none ; margin: 0px; padding: 0px; position: absolute; left: 0px; top: 0px; -moz-user-select: none; width: 59px; height: 458px;&quot; src=&quot;http://maps.google.com/intl/en_ALL/mapfiles/mapcontrols2.png&quot;/&gt;</strong>
    &lt;/div&gt;
    <strong>&lt;div style=&quot;position: absolute; left: 20px; top: 0px; width: 18px; height: 18px; cursor: pointer;&quot; title=&quot;Pan up&quot; <strong>log=&quot;pan_up&quot;</strong>/&gt;</strong>
    <strong>&lt;div style=&quot;position: absolute; left: 0px; top: 20px; width: 18px; height: 18px; cursor: pointer;&quot; title=&quot;Pan left&quot; <strong>log=&quot;pan_lt&quot;</strong>/&gt;</strong>
    <strong>&lt;div style=&quot;position: absolute; left: 40px; top: 20px; width: 18px; height: 18px; cursor: pointer;&quot; title=&quot;Pan right&quot; <strong>log=&quot;pan_rt&quot;</strong>/&gt;</strong>
    <strong>&lt;div style=&quot;position: absolute; left: 20px; top: 40px; width: 18px; height: 18px; cursor: pointer;&quot; title=&quot;Pan down&quot; <strong>log=&quot;pan_down&quot;</strong>/&gt;</strong>
    <strong>&lt;div style=&quot;position: absolute; left: 20px; top: 20px; width: 18px; height: 18px; cursor: pointer;&quot; title=&quot;Return to the last result&quot; <strong>log=&quot;center_result&quot;</strong>/&gt;</strong>
    <strong>&lt;div style=&quot;position: absolute; left: 20px; top: 65px; width: 18px; height: 18px; cursor: pointer;&quot; title=&quot;Zoom In&quot; <strong>log=&quot;zi&quot;</strong>/&gt;</strong>
  &lt;/div&gt;

  &lt;div style=&quot;position: absolute; left: 0px; top: 226px; width: 59px; height: 354px; text-align: left;&quot;&gt;
  &lt;div style=&quot;overflow: hidden; width: 59px; height: 30px; position: absolute;&quot;&gt;
    <strong>&lt;img style=&quot;border: 0px none ; margin: 0px; padding: 0px; position: absolute; left: 0px; top: -354px; -moz-user-select: none; width: 59px; height: 458px;&quot; src=&quot;http://maps.google.com/intl/en_ALL/mapfiles/mapcontrols2.png&quot;/&gt;</strong>
  &lt;/div&gt;
    <strong>&lt;div style=&quot;position: absolute; left: 20px; top: 11px; width: 18px; height: 18px; cursor: pointer;&quot; title=&quot;Zoom Out&quot; <strong>log=&quot;zo&quot;</strong>/&gt;</strong>
  &lt;/div&gt;
  &lt;div style=&quot;position: absolute; left: 19px; top: 86px; width: 22px; height: 150px; cursor: pointer;&quot;&gt;
    &lt;div style=&quot;overflow: hidden; width: 22px; height: 14px; position: absolute; left: 0px; top: 8px; cursor: url(http://maps.google.com/intl/en_ALL/mapfiles/openhand.cur), default;&quot; title=&quot;Drag to zoom&quot;&gt;
      &lt;img style=&quot;border: 0px none ; margin: 0px; padding: 0px; position: absolute; left: 0px; top: -384px; -moz-user-select: none; width: 59px; height: 458px;&quot; src=&quot;http://maps.google.com/intl/en_ALL/mapfiles/mapcontrols2.png&quot;/&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  
&lt;/div&gt;</code></pre>

<p>This block is responsible for generating the pan/zoom controls. A single PNG image (see Figure 2) is used to give the visual appearance of the control buttons, while the actual clickable areas are transparent <code>div</code> elements that are absolutely positioned on top of the image, coupled with some CSS to change the mouse to a hand icon (<code>cursor: pointer</code>). The relevant <code>onclick</code> behaviour (which triggers the actual map functions like panning and zooming) is  added by Google&#39;s script after the <code>div</code>s have been generated.</p>

<div>
<img src="http://forum-test.oslo.osa/kirby/content/articles/175-keyboardaccessible-google-maps/mapcontrols2.png" alt="The single PNG image used to display the pan/zoom controls." />
<p class="comment">Figure 2: The single PNG image used to display the pan/zoom controls</p>
</div>

<p>Similarly, the map type controls can be found in the following block of markup:</p>

<pre><code>&lt;div class=&quot;gmnoprint&quot; style=&quot;-moz-user-select: none; position: absolute; right: 7px; top: 7px; color: black; font-family: Arial,sans-serif; font-size: small; width: 200px; height: 19px;&quot;&gt;
  <strong>&lt;div <strong>id=&quot;amtc_option_0&quot;</strong> style=&quot;border: 1px solid black; position: absolute; background-color: white; text-align: center; width: 5em; cursor: pointer; right: 10.2em;&quot; title=&quot;Show street map&quot;&gt;
    &lt;div style=&quot;border-style: solid; border-color: rgb(52, 86, 132) rgb(108, 157, 223) rgb(108, 157, 223) rgb(52, 86, 132); border-width: 1px; font-size: 12px; font-weight: bold;&quot;&gt;Map&lt;/div&gt;
  &lt;/div&gt;</strong>
  <strong>&lt;div <strong>id=&quot;amtc_option_1&quot;</strong> style=&quot;border: 1px solid black; position: absolute; background-color: white; text-align: center; width: 5em; cursor: pointer; right: 5.1em;&quot; title=&quot;Show satellite imagery&quot;&gt;
    &lt;div style=&quot;border-style: solid; border-color: white rgb(176, 176, 176) rgb(176, 176, 176) white; border-width: 1px; font-size: 12px;&quot;&gt;Satellite&lt;/div&gt;
  &lt;/div&gt;</strong>
  <strong>&lt;div <strong>id=&quot;amtc_option_2&quot;</strong> style=&quot;border: 1px solid black; position: absolute; background-color: white; text-align: center; width: 5em; cursor: pointer; right: 0em;&quot; title=&quot;Show imagery with street names&quot;&gt;
    &lt;div style=&quot;border-style: solid; border-color: white rgb(176, 176, 176) rgb(176, 176, 176) white; border-width: 1px; font-size: 12px;&quot;&gt;Hybrid&lt;/div&gt;
  &lt;/div&gt;</strong>
&lt;/div&gt;</code></pre>

<p>Looking at the code that Google generates for the various controls, it quickly becomes apparent why they are not keyboard accessible. In HTML, the only elements that can receive keyboard focus (or, to put it another way, the only elements that get included in the browser/user agent tab cycle) are links, image map areas, and form elements. As used here, <code>div</code>s cannot receive focus, so a keyboard user doesn&#39;t get a chance to navigate or activate these controls when using the <kbd>Tab</kbd> key.</p>

<p class="note">It&#39;s worth noting that <a href="http://www.opera.com/support/tutorials/nomouse/#nav">Opera&#39;s keyboard navigation</a> scheme is different from that of other browsers. In normal operation, <kbd>CTRL + ↑</kbd> and <kbd>CTRL + ↓</kbd>cycles between links, while <kbd>TAB</kbd> is used to cycle between form elements—neither of any use to navigate the standard Google maps. However, Opera also has a feature it calls <em>spatial navigation</em>: <kbd>Shift + ←</kbd>,<kbd>Shift + ↑</kbd>,<kbd>Shift + →</kbd> and <kbd>Shift + ↓</kbd> allow you to move directly to links and form elements based on their position in the layout of the page. But that&#39;s not all! Spatial navigation includes heuristics that allow you to <strong>focus on arbitrary elements that have an <code>onclick</code> behaviour attached to them</strong>, meaning that the default Google maps are in fact keyboard accessible in Opera without any additional work with this navigation scheme.</p>

<p>For the sake of all other browsers, though, let&#39;s look at how to make these maps more keyboard friendly.</p>

<h2>Google&#39;s keyboard handler?</h2>

<p>Looking through Google&#39;s API documentation, we come across the initially promising <a href="http://code.google.com/apis/maps/documentation/reference.html#GKeyboardHandler">GKeyboardHandler</a> class, which adds keyboard bindings to a map. Instantiating this class with a simple</p>

<pre><code>new GKeyboardHandler(map);</code></pre>

<p>lets users navigate the map with their cursor keys, <kbd>Home</kbd> and <kbd>End</kbd> for small movements, <kbd>Page Up</kbd> and <kbd>Page Down</kbd> for large movements, and the <kbd>+</kbd> and <kbd>-</kbd> keys to control zooming.</p>

<p><a href="demo03.html">View demo 3</a> to see this in action.</p>

<p>However, the implementation of this class leaves a lot to be desired. By default, keyboard access is only possible after the map has first received at least one mouse click for activation, leaving us back where we started.</p>

<p>There is a way around this: using Google&#39;s <a href="http://code.google.com/apis/maps/documentation/reference.html#GEvent">GEvent functions</a> it&#39;s possible to simulate such a click event after the <code>GKeyboardHandler</code> has been instantiated.</p>

<pre><code>
var mapContainer = document.getElementById(&quot;map_canvas&quot;);
GEvent.trigger(document, &quot;click&quot;, 
  {srcElement: mapContainer, target: mapContainer, nodeType: 1}
);
</code></pre>

<p><a href="demo04.html">View demo 4</a> to see this in action.</p>

<p>With this code, as soon as the document is loaded and the map has been created, the keyboard handler&#39;s key bindings are active. The main problem is that now these keys are bound to the map throughout the document, not just when you want to control the map itself. These key bindings can also override any browser or assistive-technology key bindings. For instance, in Opera it&#39;s now not possible to use the cursor keys to move around the document or to use <kbd>+</kbd> and <kbd>-</kbd> to zoom the entire page. Strangely, the key bindings also get lost when activating in-page links, requiring another explicit click on the map to take effect again. And lastly, these keyboard controls are non-standard—a keyboard user would need to be informed about these new key bindings with some additional explanatory text.</p>

<p>To conclude this section, I&#39;ll keep the call to <code>GKeyboardHandler</code>  in our code—for those users that primarily navigate with a mouse but on occasion like to use keyboard controls—but do away with the flawed idea of binding the keys on page load. For true keyboard access, I&#39;ll need to come up with a different strategy.</p>

<h2>Retrofitting correct markup</h2>

<p>As already noted, the only elements that normally receive focus in keyboard navigation are links, image map areas, and form elements. So, in order to make Google maps more keyboard accessible, we want to replace the current &quot;fake&quot; controls (<code>div</code>s with associated <code>onclick</code> behaviour) with one of these elements.</p>

<p>In an ideal world, this solution should be implemented right at the source. It certainly wouldn&#39;t take Google long to make some subtle modifications to their Maps API code. Unfortunately, interest in this problem seems to be quite low. The only real mention of poor keyboard support seems to be the <a href="http://groups.google.com/group/Google-Maps-API/browse_thread/thread/1f8d49dd6dbc63ec/5210edca1c6f3ae7?lnk=gst&amp;amp;q=keyboard#5210edca1c6f3ae7">single discussion thread on the official Google Maps API group</a> that I started about a year ago.</p>

<p>Short of &quot;forking&quot; Google&#39;s code and writing our own version of the Maps API—and all the headaches associated with reverse-engineering the original JavaScript and  keeping our version in sync with the official codebase—the only option is to use the standard API and then retrofit the generated markup, injecting the most &quot;semantically appropriate&quot; keyboard-accessible HTML elements into those inaccessible controls. </p>

<h3>The injected markup</h3>

<p>Your first instinct may be to simply plump for a common <code>a</code> element. However, I&#39;d argue that in this case <code>button</code> would be a better choice—links should  be used only for navigation, not to effect changes within the current page:</p>

<blockquote><p>Push buttons have no default behaviour. Each push button may have client-side scripts associated with the element&#39;s event attributes. When an event occurs (e.g., the user presses the button, releases it, etc.), the associated  script is triggered.</p></blockquote>

<p>--<a href="http://www.w3.org/TR/html401/interact/forms.html#h-17.2.1">HTML 4.01 specification — Form Control Types</a></p>

<p>So, in simple terms, we&#39;ll create a Google map as before and then iterate over all the &quot;fake&quot; controls, creating a new <code>button</code> for each one and appending it as a new child element of the <code>div</code>. The initial pseudo-code for this is as follows:</p>

<pre><code>var button;
var divs = map.getContainer().getElementsByTagName(&#39;DIV&#39;);
for (var i = 0; i &lt; divs.length; i++) {
  if (<strong>/* one of the control DIV elements we&#39;re interested in */</strong>) {
    button = document.createElement(&quot;BUTTON&quot;);
    divs[i].appendChild(button);
  }
}</code></pre>

<p>As with other form controls, we should provide an explicit label. In the case of <code>button</code>, this is usually achieved by setting the element&#39;s <code>value</code> attribute. As all the control <code>div</code>s we&#39;re interested in also have a descriptive <code>title</code> attribute, we&#39;ll hijack that to act as our label:</p>

<pre><code>var button;
var divs = map.getContainer().getElementsByTagName(&#39;DIV&#39;);
for (var i = 0; i &lt; divs.length; i++) {
  if (<strong>/* one of the control DIV elements we&#39;re interested in */</strong>) {
    button = document.createElement(&quot;BUTTON&quot;);
    <strong>button.setAttribute(&#39;value&#39;,divs[i].getAttribute(&#39;title&#39;));</strong>
    divs[i].appendChild(button);
  }
}</code></pre>

<p>Now, looking at the markup generated by Google maps, we need to determine the appropriate hooks that will let us select the right control <code>div</code>s.</p>

<h3>Direction and zoom controls</h3>

<p>Unfortunately, the direction and zoom controls don&#39;t have any distinguishing <code>id</code> or <code>class</code> attributes. They do, however, have a non-standard <code>log</code> attribute that we can use to filter them out from the rest of the <code>div</code>s:</p>

<pre><code>var button;
var divs = map.getContainer().getElementsByTagName(&#39;DIV&#39;);
for (var i = 0; i &lt; divs.length; i++) {
  if (<strong>divs[i].hasAttribute(&#39;log&#39;)</strong>) {
    button = document.createElement(&quot;BUTTON&quot;);
    button.setAttribute(&#39;value&#39;,divs[i].getAttribute(&#39;title&#39;));
    divs[i].appendChild(button);
  }
}</code></pre>

<p>Combining this with our previous code, we get:</p>

<pre><code>function initialize() {
  if (GBrowserIsCompatible()) {
    var map = new GMap2(document.getElementById(&quot;map_canvas&quot;));
    map.setCenter(new GLatLng(53.480998, -2.236748), 15);
    map.addControl(new GLargeMapControl());
    map.addControl(new GMapTypeControl());
    map.enableScrollWheelZoom();
    map.enableContinuousZoom();
    new GKeyboardHandler(map);
    
<strong>    var button;
    var divs = map.getContainer().getElementsByTagName(&#39;DIV&#39;);
    for (var i = 0; i &lt; divs.length; i++) {
      if (divs[i].hasAttribute(&#39;log&#39;)) {
        button = document.createElement(&quot;BUTTON&quot;);
        button.setAttribute(&#39;value&#39;,divs[i].getAttribute(&#39;title&#39;));
        divs[i].appendChild(button);
      }
    }</strong>
    
  }
}</code></pre>

<p><a href="demo05.html">View demo 5</a> to see this in action.</p>

<p>Here, we come across our first JavaScript error in Internet Explorer. Although <code>hasAttribute</code> is the correct function to use when checking for the presence of an attribute, IE doesn&#39;t understand it. Grudgingly, we&#39;ll change this to <code>getAttribute</code>—modern browsers also return <var>true</var> or <var>false</var> depending on the presence of this attribute, just as with <code>hasAttribute</code>.</p>

<p>Regardless of this change, nothing seems to happen in any browser. The reason for this is that our new chunk of code is executed <em>before</em> the map has finished loading, and the controls we&#39;re trying to alter have been generated.</p>

<p>So, let&#39;s refactor the code into a separate function that can be called when the <a href="http://code.google.com/apis/maps/documentation/reference.html#GMap2.Events">Google Maps API <code>load</code> event</a> has been triggered.</p>

<blockquote><p>This event is fired when the map setup is complete, and <code>isLoaded()</code> would return <var>true</var>. This means position, zoom, and map type are all initialized, but tile images may still be loading.</p></blockquote>

<pre><code>function initialize() {
  if (GBrowserIsCompatible()) {
    var map = new GMap2(document.getElementById(&quot;map_canvas&quot;));
    <strong>GEvent.addDomListener(map, &quot;load&quot;, GKeyboardPatch(map));</strong>
    map.setCenter(new GLatLng(53.480998, -2.236748), 15);
    map.addControl(new GLargeMapControl());
    map.addControl(new GMapTypeControl());
    map.enableScrollWheelZoom();
    map.enableContinuousZoom();
    new GKeyboardHandler(map);
  }
}

<strong>function GKeyboardPatch(map) {</strong>
  var button;
  var divs = map.getContainer().getElementsByTagName(&#39;DIV&#39;);
  for (var i = 0; i &lt; divs.length; i++) {
    if (<strong>divs[i].getAttribute(&#39;log&#39;)</strong>) {
      button = document.createElement(&quot;BUTTON&quot;);
      button.setAttribute(&#39;value&#39;,divs[i].getAttribute(&#39;title&#39;));
      divs[i].appendChild(button);
    }
  }
<strong>}</strong></code></pre>

<p><a href="demo06.html">View demo 6</a> to see this in action.</p>

<p>Conceptually, this is sound, but now we&#39;re getting an undecipherable JavaScript error from the Maps API itself—<q><code>this.Wf</code> is undefined</q>. After much debugging and cursing, it appears that the <code>load</code> event actually fires <em>after</em> the map itself has been initialised (as per the documentation), but <em>before</em> the controls are generated.</p>

<p>Now, we could write some very convoluted script that keeps checking at regular intervals to see if the controls have been generated before calling the <code>GKeyboardPatch</code> function. I&#39;ll gladly leave this as a task for the reader, opting instead for a quick kludge: once the <code>load</code> event is fired, we&#39;ll give the API three seconds (based on a bit of trial and error) to sort itself out before our function call is made. This is certainly not the cleanest way to do it, and your mileage may vary if you&#39;re doing further things with the map (such as putting in additional overlays).</p>

<pre><code>GEvent.addDomListener(map, &quot;load&quot;, <strong>function() {
  setTimeout(&#39;GKeyboardPatch(map);&#39;,3000);
}</strong>);</code></pre>

<p><a href="demo07.html">View demo 7</a> to see this in action.</p>

<p>This gets rid of the nasty Maps API error, but brings to light another problem. Once we use <code>setTimeout</code>, our function call <code>GKeyboardPatch(map)</code> is executed in the document&#39;s global context, and since the <code>map</code> variable was defined inside the <code>initialize()</code> function, it&#39;s undefined at global level.</p>

<p>Again, for expediency, we&#39;ll take the easy way out and simply define <code>map</code> in the global context. There are better, far more robust ways of working around this problem by further refactoring the code, but for the sake of this article, let&#39;s go with this:</p>

<pre><code><strong>var map; // a small kludge, polluting the document&#39;s namespace</strong>
function initialize() {
  ...
}

function GKeyboardPatch(map) {
  ...
}</code></pre>


<p><a href="demo08.html">View demo 8</a> to see this in action.</p>

<p>At long last, some actual results! A few seconds after the map is initialised, we see empty <code>button</code> elements being placed over the controls, but not in IE—they&#39;re there, but not visible! More on that in a moment.</p>

<p>Because the <code>button</code>s we generated only have a <code>value</code> attribute, and no actual content, most browsers will display them as small slivers, while Safari defaults to its idiosyncratic &quot;round and shiny&quot; rendering, as seen in Figure 3.</p>

<div>
<img src="http://forum-test.oslo.osa/kirby/content/articles/175-keyboardaccessible-google-maps/demo08-safari.png" alt="Safari&#39;s &#39;round and shiny&#39; rendering of the empty button elements." width="640" height="472" />
<p class="comment">Figure 3: Safari&#39;s &#39;round and shiny&#39; rendering of the empty button elements.</p>
</div>

<p>Using default keyboard controls, we can now <kbd>Tab</kbd> to the individual controls and activate the direction and zoom functions.</p>

<h3>Doing it in style</h3>

<p>At this point, we&#39;ll start looking at the styling of these new <code>button</code> elements. We really just want them to be invisible, save for the browser&#39;s default outline once they receive focus. Working around various browser quirks and inconsistencies, I ended up with the following series of style rules (which I won&#39;t explain in any detail here—if you feel brave and have a few hours to spare, try and omit or change a few and see how that affects individual user agents):</p>

<pre><code>width: 100%;
height: 100%;
padding: 2px;
margin: 2px;
background: transparent;
border-width: 0px;
border-style: solid;
cursor: pointer;
overflow: hidden;
text-indent: -100em;
position: absolute;
top: -2px;
left: -2px;</code></pre>

<p>We could define these rules in a separate CSS style block or external style sheet, but to make this code more or less self-contained, we&#39;ll inject the styles directly in the <code>style</code> attribute of each generated <code>button</code> (since that&#39;s what the Maps API already does anyway).</p>

<pre><code>function GKeyboardPatch(map) {
  var button, <strong>button_style = 
  &#39;width:100%;height:100%;padding:2px;margin:2px; \
  background:transparent ;border-width:0px;border-style:solid; \
  cursor: pointer;overflow:hidden ;text-indent:-100em; \
  position:absolute ;top:-2px;left:-2px;&#39;;</strong>
  var divs = map.getContainer().getElementsByTagName(&#39;DIV&#39;);
  for (var i = 0; i &lt; divs.length; i++) {
    if (divs[i].getAttribute(&#39;log&#39;)) {
      button = document.createElement(&quot;BUTTON&quot;);
      title = divs[i].getAttribute(&#39;title&#39;);
      button.setAttribute(&#39;value&#39;,divs[i].getAttribute(&#39;title&#39;));
      <strong>button.setAttribute(&#39;style&#39;,button_style);</strong>
      divs[i].appendChild(button);
    }
  }
}</code></pre>

<p><a href="demo09.html">View demo 9</a> to see this in action.</p>

<p>This now seems to work reliably across all browsers, except for IE. First, let&#39;s try and get an obvious problem out of the way: IE doesn&#39;t understand <code>setAttribute(&#39;style&#39;,...)</code>. We&#39;ll modify the code to cater for all sane (compliant) browsers as well as for IE.</p>

<pre><code>// proper W3C DOM method for styling
button.setAttribute(&#39;style&#39;,button_style);
// ...and now to make it work in IE
button.style.cssText = button_style;</code></pre>

<p>Using the <a href="http://www.microsoft.com/downloads/details.aspx?familyid=E59C3964-672D-4511-BB3E-2D5E1DB91038&amp;amp;displaylang=en">Internet Explorer Developer Toolbar</a> (see Figure 4), we can see that the button styles are indeed applied now. However—and this took another lengthy round of cursing and debugging to discover—the Google Maps API also sends additional styles for the &quot;fake&quot; <code>div</code> controls to IE. Specifically, it sets <code>background-color:white </code> and the proprietary <code>filter: alpha(opacity=1)</code>.</p>

<div>
<img src="http://forum-test.oslo.osa/kirby/content/articles/175-keyboardaccessible-google-maps/demo09-ie-dev-toolbar.png" alt="Internet Explorer Developer Toolbar, showing the computed CSS properties of one of the control divs—background-color and filter:alpha(opacity=1) are highlighted." width="640" height="825" />
<p class="comment">Figure 4: Internet Explorer Developer Toolbar, showing the computed CSS properties of one of the control divs</p>
</div>

<p>Let&#39;s override these two styles for each <code>div</code> that we iterate through as well. Changing the <code>filter</code> is not a problem, but simply setting the <code>background-color</code> to <var>transparent</var> renders the controls unusable in IE for some reason. As a convoluted work-around, I&#39;ve set the <code>background</code> to a transparent PNG instead, and again, to make this code self-contained I&#39;m going to borrow one that Google Maps itself already uses elsewhere.</p>

<pre><code>for (var i = 0; i &lt; divs.length; i++) {
  if (divs[i].getAttribute(&#39;log&#39;)) {
    button = document.createElement(&quot;BUTTON&quot;);
    button.setAttribute(&#39;value&#39;,divs[i].getAttribute(&#39;title&#39;));
    // proper W3C DOM method for styling
    button.setAttribute(&#39;style&#39;,button_style);
    // ...and now to make it work in IE
    button.style.cssText = button_style;
    divs[i].appendChild(button);
    <strong>// override the IE opacity filter that Google annoyingly sets
    divs[i].style.filter = &#39;&#39;;
    // should really set to &#39;transparent&#39;
    divs[i].style.background =
    &#39;url(<strong>http://www.google.com/intl/en_ALL/mapfiles/transparent.png</strong>)&#39;;</strong>
  }
}</code></pre>

<p><a href="demo10.html">View demo 10</a> to see this in action.</p>

<p>After some head-scratching and serious markup detective work, we&#39;ve now got the direction and zoom controls working and looking as they should. Let&#39;s move on to the map style controls.</p>

<h3>Map style controls</h3>

<p>As before, we need to find the appropriate markup hooks that let us isolate and select the map style controls. Referring back to the generated markup, we see that these <code>div</code> elements do in fact have <code>id</code> attributes (<var>amtc_option_0</var>, <var>amtc_option_1</var>, and so forth, depending on which map type options you&#39;ve implemented). There&#39;s only one other type of <code>div</code> in Google&#39;s markup that has an <code>id</code>: if you&#39;ve chosen <code>map.enableContinuousZoom()</code>—as we did, simply because it looks nice in combination with <code>map.enableScrollWheelZoom()</code>—you&#39;ll find a <code>&lt;div id=&quot;map_magnifyingglass&quot; ...&gt;</code>.</p>

<p>So, on top of injecting the <code>button</code> and making the necessary style changes for all <code>div</code>s with a <code>log</code> attribute, we want to do the same for any <code>div</code> that has an <code>id</code>, but whose <code>id</code> <strong>isn&#39;t</strong> <var>map_magnifyingglass</var>. With some judicious use of brackets (for clarity) and boolean logic operators, I&#39;ve ended up with:</p>

<pre><code>
for (var i = 0; i &lt; divs.length; i++) {
  <strong>if ( divs[i].getAttribute(&#39;log&#39;) ||
       ( divs[i].getAttribute(&#39;id&#39;) &amp;&amp;
         (divs[i].getAttribute(&#39;id&#39;)!=&#39;map_magnifyingglass&#39;)
       )
     )</strong> {
    ...
  }
}
</code></pre>

<p><a href="demo11.html">View demo 11</a> to see this in action.</p>

<h3>The end result</h3>

<p>Now, we&#39;re on the home stretch. The previous code worked perfectly, but with one small glitch: the styling we applied to the <code>div</code>s to get around IE&#39;s additional style rules is now making the map type controls transparent as well. One last modification and we&#39;re good to go ... here&#39;s the complete final code:</p>

<pre><code>var map; // a small kludge, polluting the document&#39;s namespace
function initialize() {
  if (GBrowserIsCompatible()) {
    map = new GMap2(document.getElementById(&quot;map_canvas&quot;));
    GEvent.addDomListener(map, &quot;load&quot;, function() {
      setTimeout(&#39;GKeyboardPatch(map);&#39;,3000);
    });
    map.setCenter(new GLatLng(53.480998, -2.236748), 15);
    map.addControl(new GLargeMapControl());
    map.addControl(new GMapTypeControl());
    map.enableScrollWheelZoom();
    map.enableContinuousZoom();
    new GKeyboardHandler(map);      
  }
}

function GKeyboardPatch(map) {
  var button, button_style = 
  &#39;width:100%;height:100%;padding:2px;margin:2px; \
  background:transparent ; border-width:0px;border-style:solid; \
  cursor: pointer;overflow:hidden ;text-indent:-100em; \
  position:absolute ;top:-2px;left:-2px;&#39;;
  var divs = map.getContainer().getElementsByTagName(&#39;DIV&#39;);
  for (var i = 0; i &lt; divs.length; i++) {
    if ( divs[i].getAttribute(&#39;log&#39;) ||
       ( divs[i].getAttribute(&#39;id&#39;) &amp;&amp;
         (divs[i].getAttribute(&#39;id&#39;)!=&#39;map_magnifyingglass&#39;)
       )
     ) {
      button = document.createElement(&quot;BUTTON&quot;);
      button.setAttribute(&#39;value&#39;,divs[i].getAttribute(&#39;title&#39;));
      // proper W3C DOM method for styling
      button.setAttribute(&#39;style&#39;,button_style);
      // ...and now to make it work in IE
      button.style.cssText = button_style;
      divs[i].appendChild(button);
      <strong>if (divs[i].getAttribute(&#39;log&#39;)) { // only control buttons</strong>
        // override the IE opacity filter that Google annoyingly sets
        divs[i].style.filter = &#39;&#39;;
        // should really set to &#39;transparent&#39;
        divs[i].style.background =
        &#39;url(http://www.google.com/intl/en_ALL/mapfiles/transparent.png)&#39;;
      <strong>}</strong>
    }
  }
}</code></pre>

<p><a href="demo12.html">View demo 12</a> to see the final code in action.</p>

<h2>Summary</h2>

<p>It&#39;s been an arduous journey; let&#39;s recap: we&#39;ve seen that the default Google Maps aren&#39;t keyboard accessible (as they don&#39;t use appropriate elements that can receive keyboard focus by default), that Google&#39;s <code>GKeyboardHandler</code> doesn&#39;t provide a sufficient solution, and how—through some analysis of Google&#39;s generated code and a lot of fairly complex JavaScript—we can put a touch of accessibility back into these maps.</p>

<p>The final script we&#39;ve ended up with is by no means perfect. In fact, I&#39;d encourage readers to rip it apart and come up with something far more elegant. But what I&#39;d like people to consider here is the general approach taken. With a lot of third-party applications, such as Google Maps, we don&#39;t have direct control over the often quite horrific markup that is being flung onto our pages. It would be great if any major issues—particularly with regards to accessibility—were solved at the source. It certainly wouldn&#39;t take much for Google to improve their API and instantly make their maps more accessible. But, in the meantime, in order to overcome these sorts of shortcomings and cater to our users, we may have to resort to <em>retrofitting the code</em> we&#39;re given, post-processing it with some JavaScript DOM manipulation. Consider it <em>progressive enhancement</em>.</p>

<p>In this article, I&#39;ve assumed that you want to improve access to Google Maps without compromising the application&#39;s default look and feel—perhaps because you&#39;re simply adding accessibility &quot;under the radar&quot;, in an unobtrusive fashion, because your boss or designer is really fond of the way the maps are out of the box. However, if you have more flexibility and are free to change the visual appearance of the map controls, my next article will show you a cleaner way of making your maps more keyboard-accessible through the use of <a href="http://code.google.com/apis/maps/documentation/controls.html#Custom_Controls">custom controls</a>. Stay tuned!</p>
